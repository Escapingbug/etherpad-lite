language: node_js

node_js:
  - "lts/*"

services:
  - docker

cache: false

before_install:
  - sudo add-apt-repository -y ppa:libreoffice/ppa
  - sudo apt-get update
  - sudo apt-get -y install libreoffice
  - sudo apt-get -y install libreoffice-pdfimport

install:
  - "bin/installDeps.sh"
  - "export GIT_HASH=$(git rev-parse --verify --short HEAD)"

script:
  - "tests/frontend/travis/runner.sh"

jobs:
  include:
    # we can only frontend tests from the ether/ organization and not from forks.
    # To request tests to be run ask a maintainer to fork your repo to ether/
    - if: fork = false
      name: "Test the Frontend"
      secure: "VlYjz2ljT6W2trydvEyk9K7jhY1Fxfe6sUq80RNW0aMyBjPNIKsVWmzChbjOWm3AA79KUDtuPOa51Y5KGZQhsGoV7R1/XyaL2sGDMGEIzZxS84XBHHtP7xR4xmMgF53gfT0d1wng/PiDXAq33Xq9MwgEeW8I93LkIr1KIEMYZTI="
      secure: "Mx1ixqL3mCg7JKJOqGwBG3XBWptP8Sj/V4ODKMUg+TI78wkkYj8tArDTZblCP00iu20dGZIGhf0ScYcpfWiK0NdhTQA2OD0bCYzUOHtyhObz9A652IrEYA7GOMwrd5iYgRjaK4coU4u9UAP+pp6Qwmf1348az8kvissXp/n95TU="
      install:
        #FIXME
        - "sed 's/\"loglevel\": \"INFO\",/\"loglevel\": \"WARN\",/g' settings.json.template > settings.json"
        - "tests/frontend/travis/sauce_tunnel.sh"
        - "bin/installDeps.sh"
        - "export GIT_HASH=$(git rev-parse --verify --short HEAD)"
      script:
        - "tests/frontend/travis/runner.sh"
    - name: "Run the Backend tests"
      install:
        - "bin/installDeps.sh"
        - "cd src && npm install && cd -"
      script:
        - "tests/frontend/travis/runnerBackend.sh"
## Temporarily commented out the Dockerfile tests
#    - name: "Test the Dockerfile"
#      install:
#        - "cd src && npm install && cd -"
#      script:
#        - "docker build -t etherpad:test ."
#        - "docker run -d -p 9001:9001 etherpad:test && sleep 3"
#        - "cd src && npm run test-container"
    - name: "Load test Etherpad"
      install:
        - "bin/installDeps.sh"
        - "cd src && npm install && cd -"
        - "npm install -g etherpad-load-test"
      script:
        - "tests/frontend/travis/runnerLoadTest.sh"

notifications:
  irc:
    channels:
      - "irc.freenode.org#etherpad-lite-dev"
